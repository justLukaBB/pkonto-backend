<!-- P-KONTO FORMULAR - KOMPLETT F√úR ELEMENTOR HTML WIDGET -->
<!-- Einfach ALLES kopieren und in ein Elementor HTML Widget einf√ºgen -->
<!-- VERSION: 2024-12-15-DIREKT-DOM-UPDATE-V3-PERSISTENT -->

<style>
/* P-Konto Formular - ORIGINAL CSS */

* {
  box-sizing: border-box;
}

.form-container {
  width: 100%;
  background: #F1EFE9;
  font-family: 'Source Sans Pro', sans-serif;
}

/* Desktop: Zentriert mit max-width nur auf sehr gro√üen Bildschirmen */
@media (min-width: 1400px) {
  .form-container {
    max-width: 1200px;
    margin: 0 auto;
  }
}

/* Progress Steps */
.progress-steps {
  display: flex;
  justify-content: flex-start;
  padding: 40px 60px;
  gap: 40px;
}

.step {
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 18px;
  color: #999;
  cursor: pointer;
}

.step.disabled {
  cursor: not-allowed;
  opacity: 0.5;
  pointer-events: none;
}

.step.active {
  color: #EA5530;
}

.step.completed {
  color: #EA5530;
}

.step-number {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid #999;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 18px;
  background: transparent;
}

.step.active .step-number {
  border-color: #EA5530;
  color: #EA5530;
}

.step.completed .step-number {
  border-color: #EA5530;
  color: #EA5530;
}

/* Main Form Content */
.content-wrapper {
  padding: 0 60px 40px;
}

.form-content {
  display: flex;
  gap: 30px;
  align-items: flex-start;
}

.form-left {
  flex: 1;
  background: #fff;
  padding: 40px 50px;
  border-radius: 10px;
}

.form-right {
  width: 340px;
}

/* Hide/Show Steps */
.step-content {
  display: none;
}

.step-content.active {
  display: block;
}

/* Form Questions */
.form-question {
  margin-bottom: 30px;
}

.question-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
  min-height: 50px;
}

.question-text {
  font-size: 18px;
  color: #333;
  line-height: 1.5;
  font-weight: 400;
  flex: 1;
  max-width: 65%;
}

.form-section-title {
  font-size: 20px;
  font-weight: 600;
  color: #333;
  margin-bottom: 30px;
}

.section-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  color: #333;
}

/* Radio Buttons - CUSTOM CHECKBOX STYLE */
.radio-group {
  display: flex;
  gap: 30px;
  align-items: center;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.radio-option input[type="radio"] {
  appearance: none;
  -webkit-appearance: none;
  width: 22px;
  height: 22px;
  border: 2px solid #D0D0D0;
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  background: #fff;
}

.radio-option input[type="radio"]:checked {
  background: #EA5530;
  border-color: #EA5530;
}

.radio-option input[type="radio"]:checked::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #fff;
  font-size: 14px;
  font-weight: bold;
}

.radio-option input[type="checkbox"] {
  width: 22px;
  height: 22px;
  cursor: pointer;
  accent-color: #EA5530;
  border: 2px solid #D0D0D0;
  border-radius: 3px;
}

.radio-option label {
  cursor: pointer;
  font-size: 18px;
  color: #333;
}

/* Input Fields */
.input-group {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: nowrap;
  flex-shrink: 0;
}

.form-input {
  width: 160px;
  height: 50px;
  border: 1px solid #D0D0D0;
  border-radius: 3px;
  padding: 0 15px;
  font-size: 18px;
  font-family: 'Source Sans Pro', sans-serif;
  background: #fff;
  color: #000;
}

.form-input.large {
  width: 100%;
  max-width: 100%;
}

.form-input.medium {
  width: 300px;
}

.form-input.small {
  width: 140px;
}

.form-input:focus {
  outline: none;
  border-color: #EA5530;
}

select.form-input {
  background: #fff;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath fill='%23333' d='M0 0l6 8 6-8z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 15px center;
  padding-right: 40px;
  width: 100%;
  max-width: 350px;
}

/* Info Icon */
.info-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #B8B8B8;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  flex-shrink: 0;
  position: relative;
}

.info-icon:hover {
  background: #999;
}

/* Tooltip */
.info-icon .tooltip {
  visibility: hidden;
  width: 280px;
  background-color: #333;
  color: #fff;
  text-align: left;
  border-radius: 6px;
  padding: 12px 15px;
  position: absolute;
  z-index: 1000;
  bottom: 125%;
  left: 50%;
  margin-left: -140px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 14px;
  font-weight: 400;
  line-height: 1.5;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.info-icon .tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #333 transparent transparent transparent;
}

.info-icon:hover .tooltip,
.info-icon:active .tooltip {
  visibility: visible;
  opacity: 1;
}

/* Children Section */
.children-section {
  background: #F5F4F0;
  border-radius: 10px;
  padding: 25px;
  margin-bottom: 25px;
}

.children-section h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 15px;
  color: #333;
}

.children-section .question-text {
  font-size: 16px;
  margin-bottom: 10px;
  max-width: 100%;
}

.children-section .input-group {
  justify-content: flex-end;
}

.date-inputs {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 15px;
}

/* Trust Badges */
.trust-badges {
  display: flex;
  gap: 15px;
  justify-content: center;
  align-items: center;
  margin-top: 30px;
  margin-bottom: 30px;
}

.trust-badge {
  width: 80px;
  height: 80px;
  flex-shrink: 0;
}

.trust-badge img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Badges and Button Container */
.badges-button-container {
  margin-top: 40px;
}

/* Buttons */
.btn-calculate,
.btn-primary,
.btn-secondary {
  background: #EA5530;
  color: #fff;
  border: none;
  border-radius: 25px;
  padding: 15px 50px;
  font-size: 18px;
  font-family: 'Source Sans Pro', sans-serif;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
  display: block;
  margin: 0 auto;
}

.btn-calculate:hover,
.btn-primary:hover {
  background: #d14520;
}

.btn-calculate:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.btn-secondary {
  background: transparent;
  color: #EA5530;
  border: 2px solid transparent;
  padding: 13px 40px;
}

.btn-secondary:hover {
  background: transparent;
  color: #d14520;
}

.button-group {
  display: flex;
  gap: 15px;
  justify-content: space-between;
  align-items: center;
  margin-top: 30px;
}

.back-link {
  color: #EA5530;
  text-decoration: none;
  font-weight: 600;
  font-size: 16px;
}

.back-link:hover {
  text-decoration: underline;
}

/* Result Box */
.result-box {
  background: linear-gradient(135deg, #FFDDD1 0%, #FFC9B8 100%);
  border-radius: 10px;
  padding: 30px 25px;
  text-align: center;
  margin-bottom: 25px;
}

.result-label {
  font-size: 18px;
  color: #333;
  margin-bottom: 20px;
  line-height: 1.4;
  font-weight: 600;
}

.result-amount {
  background: #fff;
  border-radius: 25px;
  padding: 15px 30px;
  font-size: 26px;
  font-weight: 700;
  color: #333;
}

.result-sub-label {
  font-size: 13px;
  color: #666;
  margin-top: 15px;
  line-height: 1.3;
}

/* Review Badge */
.review-badge {
  text-align: center;
}

.review-badge img {
  max-width: 200px;
  width: 100%;
}

/* Form Grid */
.form-grid {
  display: grid;
  grid-template-columns: 150px 1fr 1fr;
  gap: 15px;
  margin-bottom: 25px;
}

.form-grid.two-col {
  grid-template-columns: 1fr 150px;
}

.form-grid.full-width {
  grid-template-columns: 1fr;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-field label {
  font-size: 14px;
  color: #333;
  font-weight: 600;
}

/* Summary Box */
.summary-box {
  background: #fff;
  border-radius: 10px;
  padding: 25px 30px;
  margin-bottom: 20px;
}

.summary-box h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #333;
}

.edit-link {
  color: #EA5530;
  font-size: 14px;
  font-weight: 400;
  cursor: pointer;
  text-decoration: none;
}

.edit-link:hover {
  text-decoration: underline;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  font-size: 14px;
}

.summary-row:not(:last-child) {
  border-bottom: 1px solid #f0f0f0;
}

/* Cost Row */
.cost-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 16px;
}

.cost-row:last-child {
  border-bottom: none;
}

.cost-row.total {
  background: #F1EFE9;
  padding: 15px 20px;
  margin: 15px -20px 0;
  border-radius: 8px;
  font-weight: 600;
  font-size: 18px;
  border-bottom: none;
}

.cost-label {
  color: #333;
}

.cost-value {
  font-weight: 600;
  color: #333;
}

/* Payment Options */
.payment-option {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.payment-option:hover {
  border-color: #EA5530;
  background: #fff8f6;
}

.payment-option input[type="radio"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.payment-logo {
  width: 50px;
  height: auto;
  object-fit: contain;
}

.payment-label {
  flex: 1;
  font-size: 14px;
  cursor: pointer;
}

/* Checkbox Group */
.checkbox-group {
  display: flex;
  gap: 15px;
  margin-bottom: 30px;
  align-items: flex-start;
}

.checkbox-group input[type="checkbox"] {
  margin-top: 3px;
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #EA5530;
}

.checkbox-group label {
  font-size: 12px;
  line-height: 1.6;
  color: #666;
  cursor: pointer;
}

.checkbox-group label a {
  color: #EA5530;
  text-decoration: none;
}

.checkbox-group label a:hover {
  text-decoration: underline;
}

/* Disclaimer */
.disclaimer {
  background-color: #f2eee8;
  padding: 20px;
  margin-top: 30px;
  border-radius: 4px;
  font-size: 14px;
  line-height: 1.6;
  color: #666;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.step-content.active {
  animation: fadeIn 0.3s ease;
}

/* Responsive Design */
@media (max-width: 992px) {
  .progress-steps {
    padding: 30px 30px;
  }

  .content-wrapper {
    padding: 0 30px 30px;
  }

  .form-content {
    flex-direction: column;
  }

  .form-right {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .form-grid.two-col {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .content-wrapper {
    padding: 0 10px 30px;
  }

  .progress-steps {
    padding: 20px 10px;
    gap: 15px;
  }

  .step {
    font-size: 14px;
  }

  .step-number {
    width: 45px;
    height: 45px;
    font-size: 16px;
  }

  .step-text {
    display: none;
  }

  .step.active .step-text {
    display: block;
  }

  .form-left {
    padding: 25px 15px;
    order: 2;
  }

  .form-right {
    order: 1;
    margin-bottom: 0px;
    width: 100%;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
    padding: 0 15px;
  }

  .result-box {
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: left;
    padding: 20px;
    background: #f6d4c2;
    margin-bottom: 0;
    border-radius: 10px;
  }

  .result-label {
    font-size: 0;
    margin-bottom: 0;
    flex: 1;
    padding-right: 15px;
    line-height: 1.3;
  }

  .result-label br {
    display: none;
  }

  .result-label::before {
    content: "Ihr monatlicher Freibetrag nach der Umwandlung";
    display: block;
    font-size: 14px;
  }

  .result-amount {
    font-size: 20px;
    white-space: nowrap;
    background: white;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 600;
  }

  .review-badge {
    display: none;
  }

  .question-wrapper {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .question-text {
    font-size: 16px;
    max-width: 100%;
    text-align: left;
    width: 100%;
  }

  .input-group {
    width: 100%;
  }

  .form-input {
    width: 100%;
  }

  .trust-badges {
    position: relative;
    padding-top: 25px;
    margin-left: -25px;
    margin-right: -25px;
    padding-left: 25px;
    padding-right: 25px;
  }

  .trust-badges::before {
    content: '';
    position: absolute;
    top: 0;
    left: 30%;
    right: 30%;
    border-top: 1px solid #E0E0E0;
  }

  .btn-calculate {
    width: 100%;
    padding: 13px 40px;
  }

  .result-amount {
    font-size: 22px;
  }

  .summary-box {
    padding: 20px 15px;
  }

  .cost-row.total {
    margin: 15px -15px 0;
    padding: 15px;
  }
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-overlay.active {
  display: flex;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #EA5530;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  color: white;
  font-size: 18px;
  margin-top: 20px;
  text-align: center;
}

.loading-overlay > div {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Success Page Styles */
#step-success {
  background: #f1efe9;
  min-height: 100vh;
  padding: 60px 30px;
}

.success-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 40px 30px;
  text-align: center;
  background: white;
  border-radius: 20px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.success-icon {
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  animation: successSlideIn 0.6s ease-out;
}

@keyframes successSlideIn {
  0% {
    transform: translateY(-20px);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

.success-icon svg {
  width: 100px;
  height: 100px;
  fill: #16a34a;
}

.success-title {
  font-size: 28px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 15px;
}

.success-message {
  font-size: 16px;
  color: #6b7280;
  margin-bottom: 30px;
  line-height: 1.6;
}

.success-info-box {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 25px;
  text-align: left;
}

.success-info-box h3 {
  font-size: 18px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.success-info-box ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.success-info-box li {
  padding: 10px 0;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  font-size: 15px;
  color: #374151;
  line-height: 1.5;
}

.success-info-box li:last-child {
  border-bottom: none;
}

.success-info-box li::before {
  content: "‚úì";
  background: #16a34a;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  flex-shrink: 0;
  font-size: 14px;
}

.success-contact {
  background: transparent;
  border: none;
  border-radius: 0;
  padding: 20px 0;
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 20px;
  border-top: 1px solid #e5e7eb;
  border-bottom: 1px solid #e5e7eb;
}

.success-contact strong {
  color: #374151;
}

.success-contact a {
  color: #EA5530 !important;
  text-decoration: none !important;
  font-weight: 600;
}

.success-contact a:hover {
  text-decoration: underline !important;
}

.success-back-btn {
  background: #EA5530;
  color: white;
  border: none;
  padding: 15px 40px;
  border-radius: 25px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 20px;
}

.success-back-btn:hover {
  background: #d64420;
}

/* Hide progress steps on success page */
.form-container.success-mode .progress-steps {
  display: none;
}

.form-container.success-mode .disclaimer {
  display: none;
}

.form-container.success-mode .form-left {
  background: transparent;
  padding: 0;
}

.form-container.success-mode {
  background: #f1efe9;
}

.form-container.success-mode .content-wrapper {
  background: #f1efe9;
}

@media (max-width: 768px) {
  #step-success {
    padding: 30px 0;
  }

  .success-container {
    width: calc(100% - 30px);
    margin-left: auto;
    margin-right: auto;
    padding: 30px 20px;
    border-radius: 15px;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    margin-bottom: 15px;
  }

  .success-icon svg {
    width: 80px;
    height: 80px;
  }

  .success-title {
    font-size: 24px;
  }

  .success-message {
    font-size: 15px;
  }

  .success-info-box {
    padding: 20px;
  }

  .success-info-box h3 {
    font-size: 16px;
  }

  .success-info-box li {
    font-size: 14px;
  }

  .success-contact {
    font-size: 13px;
  }
}
</style>

<!-- HTML STARTET HIER -->
<div class="form-container">
    <!-- Progress Steps -->
    <div class="progress-steps">
        <div class="step active" data-step="1">
            <div class="step-number">01</div>
            <div class="step-text">Freibetrag berechnen</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">02</div>
            <div class="step-text">Freibetrag sichern</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">03</div>
            <div class="step-text">Erforderliche Angaben</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-number">04</div>
            <div class="step-text">Auftrag erteilen</div>
        </div>
    </div>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Form Content -->
        <div class="form-content">
            <!-- Left Side - Form -->
            <div class="form-left">
                <!-- STEP 1: Freibetrag berechnen -->
                <div class="step-content active" id="step-1">
                    <div class="form-section-title">Jetzt online beantragen ‚Äì bundesweit g√ºltig.</div>

                    <!-- Question 1 -->
                    <div class="form-question">
                        <div class="question-wrapper">
                            <div class="question-text">Familienstand</div>
                            <div class="input-group">
                                <select class="form-input" id="familienstand">
                                    <option value="ledig">Ledig</option>
                                    <option value="verheiratet">Verheiratet</option>
                                    <option value="lebenspartnerschaft">Eingetragene Lebenspartnerschaft</option>
                                    <option value="geschieden">Geschieden / getrennt lebend</option>
                                    <option value="verwitwet">Verwitwet</option>
                                </select>
                                <div class="info-icon">
                                    i
                                    <span class="tooltip">Wenn Sie verheiratet sind oder in einer eingetragenen Lebenspartnerschaft leben, erh√∂ht sich Ihr monatlicher Freibetrag.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Question 1b: Unterhalt (conditional) -->
                    <div class="form-question" id="unterhalt-question" style="display: none;">
                        <div class="question-wrapper">
                            <div class="question-text">Leben Sie mit Ihrem Ehepartner zusammen oder zahlen Sie an Ihren getrennt lebenden Ehepartner Unterhalt?</div>
                            <div class="input-group">
                                <select class="form-input" id="unterhalt-zahlung">
                                    <option value="ja">Ja</option>
                                    <option value="nein">Nein</option>
                                </select>
                                <div class="info-icon">
                                    i
                                    <span class="tooltip">Wenn Sie zusammenleben oder Unterhalt zahlen, wird dies bei der Berechnung ber√ºcksichtigt.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Question 2 -->
                    <div class="form-question">
                        <div class="question-wrapper">
                            <div class="question-text">Haben Sie leibliche minderj√§hrige Kinder oder Kinder in der Ausbildung?</div>
                            <div class="input-group">
                                <select class="form-input" id="children-count">
                                    <option value="0">0 Kinder</option>
                                    <option value="1">1 Kind</option>
                                    <option value="2">2 Kinder</option>
                                    <option value="3">3 Kinder</option>
                                    <option value="4">4 Kinder</option>
                                    <option value="5">5 und mehr Kinder</option>
                                </select>
                                <div class="info-icon">
                                    i
                                    <span class="tooltip">Geben Sie die Anzahl Ihrer unterhaltsberechtigten Kinder an. Dies umfasst minderj√§hrige Kinder und Kinder in Ausbildung bis 25 Jahre.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Children Details Container (Step 1) -->
                    <div id="children-details-container"></div>

                    <!-- Trust Badges and Calculate Button -->
                    <div class="badges-button-container">
                        <div class="trust-badges">
                            <div class="trust-badge">
                                <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/ausgezeichnet.png" alt="Ausgezeichnet Badge">
                            </div>
                            <div class="trust-badge">
                                <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/sichere-1.png" alt="SSL Sichere Daten√ºbertragung Badge">
                            </div>
                        </div>
                        <button class="btn-calculate" onclick="window.nextStep()">Freibetrag berechnen</button>
                    </div>
                </div>

                <!-- STEP 2: Freibetrag sichern -->
                <div class="step-content" id="step-2">
                    <div class="form-section-title">Weitere Angaben f√ºr Ihren individuellen Freibetrag</div>

                    <!-- Dynamic Kindergeld Details Container (Step 2) -->
                    <div id="kindergeld-details-container-step2"></div>

                    <!-- Gesundheitsschaden Question -->
                    <div class="form-question">
                        <div class="question-wrapper">
                            <div class="question-text">Erhalten Sie Leistungen zum Ausgleich f√ºr Mehraufwand bei K√∂rper- oder Gesundheitsschaden?</div>
                            <div class="input-group">
                                <input type="number" class="form-input" placeholder="Betrag in EUR (z.B. 150)" min="0" step="0.01" id="health-compensation" value="0">
                                <div class="info-icon">
                                    i
                                    <span class="tooltip">Falls Sie monatliche Leistungen zum Ausgleich von Mehraufwand bei K√∂rper- oder Gesundheitssch√§den erhalten, geben Sie hier den Betrag in Euro an.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trust Badges and Button -->
                    <div class="badges-button-container">
                        <div class="trust-badges">
                            <div class="trust-badge">
                                <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/ausgezeichnet.png" alt="Ausgezeichnet Badge">
                            </div>
                            <div class="trust-badge">
                                <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/sichere-1.png" alt="SSL Sichere Daten√ºbertragung Badge">
                            </div>
                        </div>
                        <button class="btn-calculate" onclick="window.nextStep()">Weiter</button>
                    </div>
                </div>

                <!-- STEP 3: Erforderliche Angaben -->
                <div class="step-content" id="step-3">
                    <div class="form-section-title">F√ºr welches Konto soll der Freibetrag eingerichtet werden?</div>

                    <label class="section-label">Kontoinhaber</label>

                    <!-- Kontoinhaber -->
                    <div class="form-grid">
                        <div class="form-field">
                            <select class="form-input">
                                <option value="">Anrede</option>
                                <option value="herr">Herr</option>
                                <option value="frau">Frau</option>
                                <option value="divers">Divers</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <input type="text" class="form-input" placeholder="Vorname">
                        </div>
                        <div class="form-field">
                            <input type="text" class="form-input" placeholder="Name">
                        </div>
                    </div>

                    <div class="form-grid two-col" style="margin-top: 15px; margin-bottom: 15px;">
                        <div class="form-field">
                            <input type="text" class="form-input" placeholder="Stra√üe">
                        </div>
                        <div class="form-field">
                            <input type="text" class="form-input" placeholder="Haus-Nr.">
                        </div>
                    </div>

                    <div class="form-grid two-col" style="margin-bottom: 30px;">
                        <div class="form-field">
                            <input type="text" class="form-input" placeholder="PLZ">
                        </div>
                        <div class="form-field">
                            <input type="text" class="form-input" placeholder="Ort">
                        </div>
                    </div>

                    <!-- Geburtsdatum -->
                    <div class="form-question">
                        <label class="section-label">Geburtsdatum</label>
                        <div class="date-inputs">
                                <select class="form-input small">
                                    <option>Tag</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                    <option value="24">24</option>
                                    <option value="25">25</option>
                                    <option value="26">26</option>
                                    <option value="27">27</option>
                                    <option value="28">28</option>
                                    <option value="29">29</option>
                                    <option value="30">30</option>
                                    <option value="31">31</option>
                                </select>
                                <select class="form-input small">
                                    <option>Monat</option>
                                    <option value="1">Januar</option>
                                    <option value="2">Februar</option>
                                    <option value="3">M√§rz</option>
                                    <option value="4">April</option>
                                    <option value="5">Mai</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Dezember</option>
                                </select>
                                <select class="form-input small">
                                    <option>Jahr</option>
                                    <option value="2007">2007</option>
                                    <option value="2006">2006</option>
                                    <option value="2005">2005</option>
                                    <option value="2004">2004</option>
                                    <option value="2003">2003</option>
                                    <option value="2002">2002</option>
                                    <option value="2001">2001</option>
                                    <option value="2000">2000</option>
                                    <option value="1999">1999</option>
                                    <option value="1998">1998</option>
                                    <option value="1997">1997</option>
                                    <option value="1996">1996</option>
                                    <option value="1995">1995</option>
                                    <option value="1994">1994</option>
                                    <option value="1993">1993</option>
                                    <option value="1992">1992</option>
                                    <option value="1991">1991</option>
                                    <option value="1990">1990</option>
                                    <option value="1989">1989</option>
                                    <option value="1988">1988</option>
                                    <option value="1987">1987</option>
                                    <option value="1986">1986</option>
                                    <option value="1985">1985</option>
                                    <option value="1984">1984</option>
                                    <option value="1983">1983</option>
                                    <option value="1982">1982</option>
                                    <option value="1981">1981</option>
                                    <option value="1980">1980</option>
                                    <option value="1979">1979</option>
                                    <option value="1978">1978</option>
                                    <option value="1977">1977</option>
                                    <option value="1976">1976</option>
                                    <option value="1975">1975</option>
                                    <option value="1974">1974</option>
                                    <option value="1973">1973</option>
                                    <option value="1972">1972</option>
                                    <option value="1971">1971</option>
                                    <option value="1970">1970</option>
                                    <option value="1969">1969</option>
                                    <option value="1968">1968</option>
                                    <option value="1967">1967</option>
                                    <option value="1966">1966</option>
                                    <option value="1965">1965</option>
                                    <option value="1964">1964</option>
                                    <option value="1963">1963</option>
                                    <option value="1962">1962</option>
                                    <option value="1961">1961</option>
                                    <option value="1960">1960</option>
                                    <option value="1959">1959</option>
                                    <option value="1958">1958</option>
                                    <option value="1957">1957</option>
                                    <option value="1956">1956</option>
                                    <option value="1955">1955</option>
                                    <option value="1954">1954</option>
                                    <option value="1953">1953</option>
                                    <option value="1952">1952</option>
                                    <option value="1951">1951</option>
                                    <option value="1950">1950</option>
                                    <option value="1949">1949</option>
                                    <option value="1948">1948</option>
                                    <option value="1947">1947</option>
                                    <option value="1946">1946</option>
                                    <option value="1945">1945</option>
                                    <option value="1944">1944</option>
                                    <option value="1943">1943</option>
                                    <option value="1942">1942</option>
                                    <option value="1941">1941</option>
                                    <option value="1940">1940</option>
                                    <option value="1939">1939</option>
                                    <option value="1938">1938</option>
                                    <option value="1937">1937</option>
                                    <option value="1936">1936</option>
                                    <option value="1935">1935</option>
                                    <option value="1934">1934</option>
                                    <option value="1933">1933</option>
                                    <option value="1932">1932</option>
                                    <option value="1931">1931</option>
                                    <option value="1930">1930</option>
                                    <option value="1929">1929</option>
                                    <option value="1928">1928</option>
                                    <option value="1927">1927</option>
                                    <option value="1926">1926</option>
                                    <option value="1925">1925</option>
                                    <option value="1924">1924</option>
                                    <option value="1923">1923</option>
                                    <option value="1922">1922</option>
                                    <option value="1921">1921</option>
                                    <option value="1920">1920</option>
                                </select>
                            </div>
                    </div>

                    <!-- Kontakt -->
                    <div class="form-question">
                        <label class="section-label">Kontakt</label>
                        <input type="email" class="form-input" style="width: 100%;" placeholder="E-Mail">
                    </div>

                    <!-- Bankverbindung -->
                    <div class="form-question">
                        <label class="section-label">Bankverbindung</label>
                        <div class="form-grid two-col">
                            <input type="text" class="form-input" placeholder="IBAN">
                            <input type="text" class="form-input" placeholder="BIC/Swift-Code">
                        </div>
                    </div>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="trust-badge">
                            <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/ausgezeichnet.png" alt="Ausgezeichnet Badge">
                        </div>
                        <div class="trust-badge">
                            <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/sichere-1.png" alt="SSL Sichere Daten√ºbertragung Badge">
                        </div>
                    </div>

                    <!-- Button Group -->
                    <div class="button-group">
                        <a href="#" class="back-link" onclick="previousStep(); return false;">Zur√ºck</a>
                        <button class="btn-calculate" onclick="window.nextStep()">Daten pr√ºfen</button>
                    </div>
                </div>

                <!-- STEP 4: Auftrag erteilen -->
                <div class="step-content" id="step-4">
                    <!-- Summary Section 1 -->
                    <div class="summary-box">
                        <h3>
                            Ihre Angaben zur Berechnung des Freibetrages
                            <a href="#" class="edit-link" onclick="window.goToStep(1); return false;">Bearbeiten</a>
                        </h3>
                        <div id="summary-calculation-details">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div>

                    <!-- Summary Section 2 -->
                    <div class="summary-box">
                        <h3>
                            Ihre pers√∂nlichen Daten
                            <a href="#" class="edit-link" onclick="window.goToStep(3); return false;">Bearbeiten</a>
                        </h3>
                        <div class="summary-row" style="border-bottom: none;">
                            <div>
                                <div style="margin-bottom: 10px;" id="summary-name">Herr Max Mustermann</div>
                                <div style="margin-bottom: 10px;" id="summary-address">Musterstra√üe 15</div>
                                <div id="summary-city">40210 D√ºsseldorf</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="margin-bottom: 5px; font-weight: 600;">Bankverbindung:</div>
                                <div style="margin-bottom: 5px;" id="summary-iban">IBAN: DE123456789251455215</div>
                                <div id="summary-bic">BIC/Swift-Code: 215855115</div>
                            </div>
                        </div>
                        <div class="summary-row" style="border-top: 1px solid #f0f0f0;">
                            <div class="cost-label" id="summary-birthdate">Geburtsdatum: 11.05.1964</div>
                            <div class="cost-value"></div>
                        </div>
                        <div class="summary-row">
                            <div class="cost-label" style="color: #EA5530;" id="summary-email">test@test.de</div>
                            <div class="cost-value"></div>
                        </div>
                    </div>

                    <!-- Payment Options (Dynamic from Mollie) -->
                    <div class="summary-box">
                        <h3>Wie m√∂chten Sie bezahlen?</h3>

                        <!-- Loading State -->
                        <div id="payment-methods-loading" style="text-align: center; padding: 20px;">
                            <div style="font-size: 16px; color: #666;">Lade Zahlungsmethoden...</div>
                        </div>

                        <!-- Payment Methods Container -->
                        <div id="payment-methods-container" style="display: none;">
                            <!-- Will be filled dynamically with Mollie payment methods -->
                        </div>

                        <!-- Error State -->
                        <div id="payment-methods-error" style="display: none; padding: 15px; background: #fee; border-radius: 8px; color: #c00;">
                            Fehler beim Laden der Zahlungsmethoden. Bitte versuchen Sie es erneut.
                        </div>
                    </div>

                    <!-- Geb√ºhren und Kosten Section -->
                    <div class="summary-box" style="margin-top: 30px;">
                        <h3>Geb√ºhren und Kosten</h3>
                        <div class="cost-row">
                            <div class="cost-label">Erstellung und Beglaubigung der P-Konto Bescheinigung</div>
                            <div class="cost-value">29,00 ‚Ç¨</div>
                        </div>
                        <div class="cost-row">
                            <div class="cost-label">Versand (per Post)</div>
                            <div class="cost-value">0,00 ‚Ç¨</div>
                        </div>
                        <div class="cost-row">
                            <div class="cost-label">Bezahlart: Sofort√ºberweisung</div>
                            <div class="cost-value">0,00 ‚Ç¨</div>
                        </div>
                        <div class="cost-row total">
                            <div class="cost-label">Gesamtbetrag (inkl. MwSt.)</div>
                            <div class="cost-value">29,00 ‚Ç¨</div>
                        </div>
                    </div>

                    <!-- Checkbox Agreement -->
                    <div class="checkbox-group" style="margin-top: 30px;">
                        <input type="checkbox" id="agreement">
                        <label for="agreement">
                            Mit Absenden des Formulars best√§tige ich die Richtigkeit meiner Angaben und beauftrage Herrn Rechtsanwalt Thomas Scuric, die Bescheinigung nach ¬ß 850k ZPO zur Erh√∂hung des Freibetrages auf meinem Pf√§ndungsschutzkonto zu erstellen und zu beglaubigen. Die <a href="#">AGB</a> und <a href="#">Widerrufsbelehrung</a> habe ich gelesen und stimme ihnen zu. Mir ist au√üerdem bekannt, dass die Verwendung einer durch Falschangaben erstellte Bescheinigung strafbar ist.
                        </label>
                    </div>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="trust-badge">
                            <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/ausgezeichnet.png" alt="Ausgezeichnet Badge">
                        </div>
                        <div class="trust-badge">
                            <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/sichere-1.png" alt="SSL Sichere Daten√ºbertragung Badge">
                        </div>
                    </div>

                    <!-- Final Submit Button -->
                    <button class="btn-calculate" style="margin-top: 30px;" onclick="window.submitForm()">Jetzt kostenpflichtig beauftragen</button>
                </div>

                <!-- STEP 5: Success Page -->
                <div class="step-content" id="step-success" style="display: none;">
                    <div class="success-container">
                        <!-- Success Icon - Document with Checkmark Badge -->
                        <div class="success-icon">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <!-- Document -->
                                <path d="M25 10 L60 10 L75 25 L75 90 L25 90 Z" fill="#f3f4f6" stroke="#d1d5db" stroke-width="2"/>
                                <!-- Folded Corner -->
                                <path d="M60 10 L60 25 L75 25" fill="#e5e7eb" stroke="#d1d5db" stroke-width="2"/>
                                <!-- Document Lines -->
                                <line x1="35" y1="35" x2="65" y2="35" stroke="#9ca3af" stroke-width="2"/>
                                <line x1="35" y1="45" x2="65" y2="45" stroke="#9ca3af" stroke-width="2"/>
                                <line x1="35" y1="55" x2="55" y2="55" stroke="#9ca3af" stroke-width="2"/>
                                <!-- Green Success Badge -->
                                <circle cx="70" cy="70" r="18" fill="#16a34a"/>
                                <!-- White Checkmark -->
                                <path d="M63 70 L68 75 L78 65" stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>

                        <!-- Success Title -->
                        <h1 class="success-title">Auftrag erfolgreich abgeschlossen!</h1>

                        <!-- Success Message -->
                        <p class="success-message">
                            Vielen Dank f√ºr Ihren Auftrag! Ihre Zahlung wurde erfolgreich verarbeitet und Ihre P-Konto Bescheinigung wird nun erstellt.
                        </p>

                        <!-- Info Box -->
                        <div class="success-info-box">
                            <h3>üìß Wie geht es weiter?</h3>
                            <ul>
                                <li>Sie erhalten in K√ºrze eine E-Mail mit Ihrer beglaubigten P-Konto Bescheinigung</li>
                                <li>Bitte pr√ºfen Sie auch Ihren Spam-Ordner, falls die E-Mail nicht innerhalb von 10 Minuten eintrifft</li>
                                <li>Legen Sie die Bescheinigung Ihrer Bank vor, um den erh√∂hten Freibetrag einzurichten</li>
                            </ul>
                        </div>

                        <!-- Contact Info -->
                        <div class="success-contact">
                            <strong>Fragen oder Probleme?</strong><br>
                            Kontaktieren Sie uns unter: <a href="mailto:info@ra-scuric.de" style="color: #1e3a8a; text-decoration: underline;">info@ra-scuric.de</a> oder Tel: 0234 913 681 0
                        </div>

                        <!-- Back to Homepage Button -->
                        <button class="success-back-btn" onclick="window.location.href='https://p-konto-bescheinigung.com'">
                            Zur√ºck zur Startseite
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Side - Result Box -->
            <div class="form-right">
                <!-- Result Box -->
                <div class="result-box">
                    <div class="result-label">Ihr montl. Freibetrag<br><br>Nach der Umwandlung ergibt sich folgender Freibetrag:</div>
                    <div class="result-amount" id="result-amount">1.410,64 ‚Ç¨</div>
                    <div class="result-sub-label" id="result-sub-label"></div>
                </div>

                <!-- Review Badge -->
                <div class="review-badge">
                    <img src="https://p-konto-bescheinigung.com/wp-content/uploads/2025/11/Siegel.png" alt="Sehr Gut 4.98/5.00 - 204 Bewertungen">
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer" id="disclaimer-text">
        Beziehen Sie zus√§tzlich einmalige Sozialleistungen wie z.B. Zusch√ºsse zu Klassenfahrten, Darlehen f√ºr Umzugshilfen oder Kautionen vom Jobcenter etc., dann legen Sie den Bewilligungsbescheid Ihrer Bank vor. Ihre Bank wird dann einen einmaligen zus√§tzlichen Freibetrag f√ºr den entsprechenden Monat gew√§hren.
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div style="text-align: center;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Zahlung wird vorbereitet...<br>Bitte warten Sie einen Moment.</div>
    </div>
</div>
<script>
// P-KONTO FORM - DEBUG VERSION (ohne Emojis f√ºr bessere Kompatibilit√§t)
console.log('===============================================');
console.log('P-Konto Form Script laeuft...');
console.log('Zeit:', new Date().toLocaleTimeString());
console.log('===============================================');

// Check WordPress - create if not exists
console.log('WordPress Integration Check:');
console.log('  PKONTO_CONFIG existiert?', typeof PKONTO_CONFIG !== 'undefined');

// Create PKONTO_CONFIG if it doesn't exist
if (typeof PKONTO_CONFIG === 'undefined') {
    console.warn('  WARNUNG - PKONTO_CONFIG nicht gefunden! Erstelle lokale Kopie...');
    window.PKONTO_CONFIG = {
        product_id: 571,
        ajax_url: window.location.origin + '/wp-admin/admin-ajax.php',
        checkout_url: window.location.origin + '/?page_id=520',
        backend_url: 'https://pkonto-backend-1.onrender.com'
    };
    console.log('  OK - PKONTO_CONFIG erstellt:', PKONTO_CONFIG);
} else {
    console.log('  OK - PKONTO_CONFIG gefunden:', PKONTO_CONFIG);
}

// Config
const PKONTO_FORM_CONFIG = {
    backendUrl: 'https://pkonto-backend-1.onrender.com',
    productId: 571,
    baseFreibetrag: 1560.00
};

console.log('Form Config:', PKONTO_FORM_CONFIG);

// ============================================================
// CHECK FOR SUCCESS PAGE (after payment redirect from Mollie)
// ============================================================
(function checkForSuccessPage() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    const applicationId = urlParams.get('application_id');

    console.log('URL Parameters:', {
        paymentStatus: paymentStatus,
        applicationId: applicationId
    });

    if (paymentStatus === 'success' && applicationId) {
        console.log('SUCCESS PAGE DETECTED! Showing success view...');

        // Wait for DOM to be ready
        setTimeout(function() {
            // Hide all step-content
            const allSteps = document.querySelectorAll('.step-content');
            allSteps.forEach(step => step.style.display = 'none');

            // Show success page
            const successPage = document.getElementById('step-success');
            if (successPage) {
                successPage.style.display = 'block';
                console.log('Success page shown');
            }

            // Add success-mode class to form-container
            const formContainer = document.querySelector('.form-container');
            if (formContainer) {
                formContainer.classList.add('success-mode');
                console.log('success-mode class added to form-container');
            }

            // Hide form-right (result box)
            const formRight = document.querySelector('.form-right');
            if (formRight) {
                formRight.style.display = 'none';
                console.log('form-right hidden');
            }

            // Make form-left full width
            const formLeft = document.querySelector('.form-left');
            if (formLeft) {
                formLeft.style.flex = '1';
                formLeft.style.maxWidth = '100%';
                console.log('form-left set to full width');
            }

            // Make content-wrapper centered
            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) {
                contentWrapper.style.maxWidth = '900px';
                contentWrapper.style.margin = '0 auto';
                console.log('content-wrapper centered');
            }

            // Scroll to form container
            setTimeout(function() {
                const formContainer = document.querySelector('.form-container');
                if (formContainer) {
                    formContainer.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    console.log('Scrolled to form container');
                }
            }, 200);
        }, 100);

        return true; // Success page is active
    }

    return false; // Normal form flow
})();

// Global State
window.pkontoFormData = {
    calculationData: {
        familienstand: 'ledig',
        unterhalt: 'nein',
        married: false,
        childrenCount: 0,
        children: [],
        socialBenefitsCount: 0,
        healthCompensation: 0
    },
    personalData: {
        salutation: '',
        firstName: '',
        lastName: '',
        street: '',
        houseNumber: '',
        zipCode: '',
        city: '',
        birthdate: { day: 0, month: 0, year: 0 },
        email: '',
        phone: ''
    },
    bankData: {
        iban: '',
        bic: ''
    },
    calculatedFreibetrag: {
        amount: PKONTO_FORM_CONFIG.baseFreibetrag,
        details: ''
    },
    payment: {
        method: 'paypal',
        amount: 29.00,
        status: 'pending'
    }
};

window.pkontoCurrentStep = 1;
window.pkontoMaxStep = 1; // Tracks the maximum reached step

console.log('Initial FormData erstellt');

// Add click handlers to progress steps
setTimeout(function() {
    const progressSteps = document.querySelectorAll('.progress-steps .step');
    progressSteps.forEach(function(stepEl) {
        stepEl.addEventListener('click', function() {
            const targetStep = parseInt(stepEl.getAttribute('data-step'));
            if (targetStep && targetStep <= window.pkontoMaxStep) {
                window.goToStep(targetStep);
            }
        });
    });
    console.log('‚úì Step click handlers added');
}, 100);

// Familienstand Change Handler - Show/Hide Unterhalt Question
function handleFamilienstandChange() {
    const familienstand = document.getElementById('familienstand');
    const unterhaltQuestion = document.getElementById('unterhalt-question');

    if (familienstand && unterhaltQuestion) {
        const value = familienstand.value;
        // Show question for verheiratet, lebenspartnerschaft, geschieden
        if (value === 'verheiratet' || value === 'lebenspartnerschaft' || value === 'geschieden') {
            unterhaltQuestion.style.display = 'block';
        } else {
            unterhaltQuestion.style.display = 'none';
        }
    }
}

// Attach event listener to familienstand dropdown
setTimeout(function() {
    const familienstand = document.getElementById('familienstand');
    if (familienstand) {
        familienstand.addEventListener('change', handleFamilienstandChange);
        // Check initial state
        handleFamilienstandChange();
    }
}, 100);

// Navigate to step
window.goToStep = function(step) {
    console.log('-----------------------------------------------');
    console.log('goToStep:', step);
    console.log('-----------------------------------------------');

    if (step < 1 || step > 4) {
        console.error('FEHLER - Invalid step:', step);
        return;
    }

    // Update max step if moving forward
    if (step > window.pkontoMaxStep) {
        window.pkontoMaxStep = step;
    }

    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('step-' + i);
        if (stepEl) {
            stepEl.classList.remove('active');
        }

        const progressStep = document.querySelector('[data-step="' + i + '"]');
        if (progressStep) {
            progressStep.classList.remove('active');
            progressStep.classList.remove('disabled');

            if (i < step) {
                progressStep.classList.add('completed');
            } else {
                progressStep.classList.remove('completed');
            }

            // Disable steps that haven't been reached yet
            if (i > window.pkontoMaxStep) {
                progressStep.classList.add('disabled');
            }
        }
    }

    const currentStepEl = document.getElementById('step-' + step);
    if (currentStepEl) {
        currentStepEl.classList.add('active');
        console.log('OK - Step', step, 'ist jetzt aktiv');
    } else {
        console.error('FEHLER - Step element nicht gefunden:', 'step-' + step);
    }

    const currentProgressStep = document.querySelector('[data-step="' + step + '"]');
    if (currentProgressStep) currentProgressStep.classList.add('active');

    window.pkontoCurrentStep = step;

    // Generate Kindergeld details when navigating to Step 2
    if (step === 2) {
        console.log('DEBUG: Step 2 Navigation detected');
        const kindergeldCountSelect = document.getElementById('kindergeld-count');
        console.log('DEBUG: kindergeld-count element:', kindergeldCountSelect);
        const kindergeldCount = kindergeldCountSelect ? parseInt(kindergeldCountSelect.value) || 0 : 0;
        console.log(`DEBUG: Kindergeld Count = ${kindergeldCount}`);

        // Check if container exists
        const container = document.getElementById('kindergeld-details-container-step2');
        console.log('DEBUG: Container found:', container);

        console.log(`Step 2 aktiviert - generiere Geburtsdatum-Eingaben f√ºr ${kindergeldCount} Kind(er) mit Kindergeld`);
        generateKindergeldDetails(kindergeldCount);
    }

    // Update summary when navigating to Step 4
    if (step === 4) {
        console.log('DEBUG: Step 4 Navigation detected - updating summary');
        updateSummary();
        // Load Mollie payment methods
        loadPaymentMethods();
    }

    // Auto-Scroll zum Formular nach Step-Wechsel
    setTimeout(function() {
        const formContainer = document.querySelector('.form-container');
        if (formContainer) {
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 100);

    console.log('OK - Navigation abgeschlossen');
};

// Collect data
function collectStepData() {
    console.log('-----------------------------------------------');
    console.log('collectStepData() - Step:', window.pkontoCurrentStep);
    console.log('-----------------------------------------------');

    const step = window.pkontoCurrentStep;
    const data = window.pkontoFormData;

    if (step === 1) {
        const familienstand = document.getElementById('familienstand');
        const unterhaltZahlung = document.getElementById('unterhalt-zahlung');
        const childrenCount = document.getElementById('children-count');

        // Familienstand auslesen und married-Status setzen
        const familienstandValue = familienstand ? familienstand.value : 'ledig';
        data.calculationData.familienstand = familienstandValue;

        // Unterhalt-Zahlung auslesen (nur relevant wenn Frage sichtbar war)
        const unterhaltValue = unterhaltZahlung ? unterhaltZahlung.value : 'nein';
        data.calculationData.unterhalt = unterhaltValue;

        // Verheiratet oder Lebenspartnerschaft erh√∂hen Freibetrag (nur wenn zusammenlebend oder Unterhalt gezahlt wird)
        const showsUnterhaltQuestion = (familienstandValue === 'verheiratet' || familienstandValue === 'lebenspartnerschaft' || familienstandValue === 'geschieden');
        if (showsUnterhaltQuestion && unterhaltValue === 'ja') {
            data.calculationData.married = true;
        } else {
            data.calculationData.married = false;
        }

        data.calculationData.childrenCount = childrenCount ? parseInt(childrenCount.value) || 0 : 0;

        console.log('Step 1 Daten gesammelt:');
        console.log('  Familienstand:', data.calculationData.familienstand);
        console.log('  Unterhalt:', data.calculationData.unterhalt);
        console.log('  Verheiratet/Lebenspartnerschaft (Freibetrag):', data.calculationData.married ? 'JA' : 'NEIN');
        console.log('  Kinder gesamt:', data.calculationData.childrenCount);
        console.log('  (Kindergeld-Details werden auf Step 2 gesammelt)');
    }

    if (step === 2) {
        // Collect Kindergeld count and children details (NOW on Step 2)
        data.calculationData.children = [];

        const kindergeldCountSelect = document.getElementById('kindergeld-count');
        const kindergeldCount = kindergeldCountSelect ? parseInt(kindergeldCountSelect.value) || 0 : 0;

        console.log(`  Kinder mit Kindergeld: ${kindergeldCount}`);

        // Collect details only for children with Kindergeld
        for (let i = 1; i <= kindergeldCount; i++) {
            const daySelect = document.getElementById(`kindergeld-child-${i}-day`);
            const monthSelect = document.getElementById(`kindergeld-child-${i}-month`);
            const yearSelect = document.getElementById(`kindergeld-child-${i}-year`);

            const child = {
                birthdate: {
                    day: daySelect ? parseInt(daySelect.value) || 0 : 0,
                    month: monthSelect ? parseInt(monthSelect.value) || 0 : 0,
                    year: yearSelect ? parseInt(yearSelect.value) || 0 : 0
                },
                receivesKindergeld: true  // All these children receive Kindergeld
            };

            data.calculationData.children.push(child);
            console.log(`  Kind ${i} (mit Kindergeld):`, child.birthdate);
        }

        // Collect health compensation
        const healthCompensationInput = document.getElementById('health-compensation');
        data.calculationData.healthCompensation = healthCompensationInput ? parseFloat(healthCompensationInput.value) || 0 : 0;

        console.log('Step 2 Daten gesammelt:');
        console.log('  Kinder mit Kindergeld:', kindergeldCount);
        console.log('  Kinder-Details:', data.calculationData.children);
        console.log('  Gesundheitsschaden-Ausgleich:', data.calculationData.healthCompensation);
    }

    if (step === 3) {
        const step3 = document.getElementById('step-3');
        if (!step3) {
            console.error('FEHLER - Step 3 element nicht gefunden!');
            return;
        }

        const selects = step3.querySelectorAll('select');
        const inputs = step3.querySelectorAll('input[type="text"], input[type="email"]');

        // Salutation - ensure lowercase
        if (selects.length > 0) data.personalData.salutation = selects[0].value.toLowerCase();
        if (inputs.length > 0) data.personalData.firstName = inputs[0].value;
        if (inputs.length > 1) data.personalData.lastName = inputs[1].value;
        if (inputs.length > 2) data.personalData.street = inputs[2].value;
        if (inputs.length > 3) data.personalData.houseNumber = inputs[3].value;
        if (inputs.length > 4) data.personalData.zipCode = inputs[4].value;
        if (inputs.length > 5) data.personalData.city = inputs[5].value;

        const emailInput = step3.querySelector('input[type="email"]');
        if (emailInput) data.personalData.email = emailInput.value;

        // Birthdate - convert to numbers
        if (selects.length >= 4) {
            data.personalData.birthdate.day = parseInt(selects[1].value) || 0;
            data.personalData.birthdate.month = parseInt(selects[2].value) || 0;
            data.personalData.birthdate.year = parseInt(selects[3].value) || 0;
        }

        const ibanInput = step3.querySelector('input[placeholder="IBAN"]');
        const bicInput = step3.querySelector('input[placeholder="BIC/Swift-Code"]');
        if (ibanInput) data.bankData.iban = ibanInput.value;
        if (bicInput) data.bankData.bic = bicInput.value;

        console.log('Step 3 Daten gesammelt:');
        console.log('  Salutation:', data.personalData.salutation);
        console.log('  Name:', data.personalData.firstName, data.personalData.lastName);
        console.log('  Birthdate:', data.personalData.birthdate);
        console.log('  Email:', data.personalData.email);
        console.log('  IBAN:', data.bankData.iban);
        console.log('  BIC:', data.bankData.bic);
    }

    console.log('Komplette FormData:', data);
}

// Validate
function validateCurrentStep() {
    const step = window.pkontoCurrentStep;
    console.log('-----------------------------------------------');
    console.log('validateCurrentStep() - Step:', step);
    console.log('-----------------------------------------------');

    if (step === 1) {
        console.log('OK - Keine Validierung fuer Step 1');
        return true;
    }

    if (step === 2) {
        // Validate Kindergeld details if any children with Kindergeld were selected
        const kindergeldCountSelect = document.getElementById('kindergeld-count');
        const kindergeldCount = kindergeldCountSelect ? parseInt(kindergeldCountSelect.value) || 0 : 0;

        if (kindergeldCount > 0) {
            console.log(`Validiere Eingaben f√ºr ${kindergeldCount} Kind(er) mit Kindergeld...`);

            for (let i = 1; i <= kindergeldCount; i++) {
                const daySelect = document.getElementById(`kindergeld-child-${i}-day`);
                const monthSelect = document.getElementById(`kindergeld-child-${i}-month`);
                const yearSelect = document.getElementById(`kindergeld-child-${i}-year`);

                if (!daySelect || !daySelect.value) {
                    alert(`Bitte geben Sie den Tag des Geburtstags f√ºr Kind ${i} (mit Kindergeld) an.`);
                    return false;
                }

                if (!monthSelect || !monthSelect.value) {
                    alert(`Bitte geben Sie den Monat des Geburtstags f√ºr Kind ${i} (mit Kindergeld) an.`);
                    return false;
                }

                if (!yearSelect || !yearSelect.value) {
                    alert(`Bitte geben Sie das Jahr des Geburtstags f√ºr Kind ${i} (mit Kindergeld) an.`);
                    return false;
                }

                console.log(`‚úì Kind ${i} mit Kindergeld validiert`);
            }
        }

        console.log('OK - Step 2 validiert');
        return true;
    }

    if (step === 3) {
        const step3 = document.getElementById('step-3');
        if (!step3) {
            console.error('FEHLER - Step 3 element nicht gefunden!');
            return false;
        }

        const salutationSelect = step3.querySelector('select');
        const inputs = step3.querySelectorAll('input[type="text"]');
        const emailInput = step3.querySelector('input[type="email"]');
        const ibanInput = step3.querySelector('input[placeholder="IBAN"]');

        if (!salutationSelect || !salutationSelect.value) {
            console.warn('WARNUNG - Anrede fehlt');
            alert('Bitte waehlen Sie eine Anrede.');
            return false;
        }

        if (!inputs[0] || !inputs[0].value.trim()) {
            console.warn('WARNUNG - Vorname fehlt');
            alert('Bitte geben Sie Ihren Vornamen ein.');
            return false;
        }

        if (!inputs[1] || !inputs[1].value.trim()) {
            console.warn('WARNUNG - Nachname fehlt');
            alert('Bitte geben Sie Ihren Nachnamen ein.');
            return false;
        }

        if (!inputs[4] || !inputs[4].value.trim()) {
            console.warn('WARNUNG - PLZ fehlt');
            alert('Bitte geben Sie Ihre Postleitzahl ein.');
            return false;
        }

        if (!inputs[5] || !inputs[5].value.trim()) {
            console.warn('WARNUNG - Ort fehlt');
            alert('Bitte geben Sie Ihren Ort ein.');
            return false;
        }

        if (!emailInput || !emailInput.value.trim()) {
            console.warn('WARNUNG - Email fehlt');
            alert('Bitte geben Sie Ihre E-Mail-Adresse ein.');
            return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailInput.value)) {
            console.warn('WARNUNG - Email ungueltig');
            alert('Bitte geben Sie eine gueltige E-Mail-Adresse ein.');
            return false;
        }

        // Birthdate validation
        const selects = step3.querySelectorAll('select');
        if (selects.length >= 4) {
            const dayValue = selects[1].value;
            const monthValue = selects[2].value;
            const yearValue = selects[3].value;

            if (!dayValue || dayValue === 'Tag') {
                console.warn('WARNUNG - Geburtstag fehlt');
                alert('Bitte w√§hlen Sie Ihren Geburtstag aus.');
                return false;
            }

            if (!monthValue || monthValue === 'Monat') {
                console.warn('WARNUNG - Geburtsmonat fehlt');
                alert('Bitte w√§hlen Sie Ihren Geburtsmonat aus.');
                return false;
            }

            if (!yearValue || yearValue === 'Jahr') {
                console.warn('WARNUNG - Geburtsjahr fehlt');
                alert('Bitte w√§hlen Sie Ihr Geburtsjahr aus.');
                return false;
            }
        }

        if (!ibanInput || !ibanInput.value.trim()) {
            console.warn('WARNUNG - IBAN fehlt');
            alert('Bitte geben Sie Ihre IBAN ein.');
            return false;
        }

        const bicInput = step3.querySelector('input[placeholder="BIC/Swift-Code"]');
        if (!bicInput || !bicInput.value.trim()) {
            console.warn('WARNUNG - BIC fehlt');
            alert('Bitte geben Sie Ihren BIC/Swift-Code ein.');
            return false;
        }

        console.log('OK - Step 3 Validierung erfolgreich');
    }

    if (step === 4) {
        const checkbox = document.getElementById('agreement');
        if (!checkbox || !checkbox.checked) {
            console.warn('WARNUNG - AGB nicht akzeptiert');
            alert('Bitte bestaetigen Sie die AGB und Widerrufsbelehrung.');
            return false;
        }
        console.log('OK - Step 4 Validierung erfolgreich');
    }

    return true;
}

// Calculate Freibetrag
function calculateFreibetrag() {
    console.log('-----------------------------------------------');
    console.log('calculateFreibetrag()');
    console.log('-----------------------------------------------');

    const data = window.pkontoFormData;
    let amount = PKONTO_FORM_CONFIG.baseFreibetrag;

    console.log('  Basis:', amount.toFixed(2), 'EUR');

    if (data.calculationData.married) {
        amount += 585.23;
        console.log('  + Verheiratet/Lebenspartnerschaft: 585.23 EUR');
    }

    if (data.calculationData.childrenCount > 0) {
        const childBonus = data.calculationData.childrenCount * 326.04;
        amount += childBonus;
        console.log('  +', data.calculationData.childrenCount, 'Kind(er):', childBonus.toFixed(2), 'EUR');
    }

    if (data.calculationData.healthCompensation > 0) {
        amount += data.calculationData.healthCompensation;
        console.log('  + Gesundheitsschaden:', data.calculationData.healthCompensation.toFixed(2), 'EUR');
    }

    data.calculatedFreibetrag.amount = amount;

    console.log('  =========================================');
    console.log('  GESAMT FREIBETRAG:', amount.toFixed(2), 'EUR');
    console.log('  =========================================');

    updateResultBox();
}

// Update result box
function updateResultBox() {
    console.log('üîç updateResultBox() called');
    const resultAmount = document.getElementById('result-amount');
    console.log('üîç resultAmount element:', resultAmount);
    if (resultAmount) {
        const amount = window.pkontoFormData.calculatedFreibetrag.amount;
        console.log('üîç Amount from data:', amount);
        const formatted = amount.toFixed(2).replace('.', ',') + ' EUR';
        console.log('üîç Formatted amount:', formatted);
        console.log('üîç Current textContent before update:', resultAmount.textContent);
        resultAmount.textContent = formatted;
        console.log('üîç textContent after setting:', resultAmount.textContent);
        console.log('‚úÖ Result Box aktualisiert:', formatted);
    } else {
        console.error('‚ùå FEHLER - Result Box Element mit ID "result-amount" nicht gefunden!');
        console.log('üîç Alle Elemente mit class "result-amount":', document.querySelectorAll('.result-amount'));
    }
}

// Update summary
function updateSummary() {
    console.log('===============================================');
    console.log('updateSummary() - F√ºlle Step 4 mit echten Daten');
    console.log('===============================================');

    const data = window.pkontoFormData;

    // ========== SECTION 1: Berechnung des Freibetrages ==========
    const summaryCalcDetails = document.getElementById('summary-calculation-details');
    if (summaryCalcDetails) {
        let html = '';

        // Familienstand/Verheiratet
        const marriedText = data.calculationData.married ? 'Ja' : 'Nein';
        html += `
            <div class="summary-row">
                <div class="cost-label">Verheiratet/Lebenspartnerschaft</div>
                <div class="cost-value">${marriedText}</div>
            </div>
        `;

        // Kinder mit Kindergeld
        if (data.calculationData.childrenCount > 0) {
            data.calculationData.children.forEach((child, index) => {
                const birthdate = `${child.birthdate.day}.${child.birthdate.month}.${child.birthdate.year}`;
                const kindergeldText = child.receivesKindergeld ? 'Ja' : 'Nein';
                html += `
                    <div class="summary-row">
                        <div class="cost-label">Kind ${index + 1} - Geboren am ${birthdate}</div>
                        <div class="cost-value">Kindergeld: ${kindergeldText}</div>
                    </div>
                `;
            });
        }

        // Anzahl weiterer Personen mit Sozialleistungen
        if (data.calculationData.socialBenefitsCount > 0) {
            html += `
                <div class="summary-row">
                    <div class="cost-label">Weitere Personen mit Sozialleistungen</div>
                    <div class="cost-value">${data.calculationData.socialBenefitsCount}</div>
                </div>
            `;
        }

        // Gesundheitsschaden
        if (data.calculationData.healthCompensation > 0) {
            html += `
                <div class="summary-row">
                    <div class="cost-label">Gesundheitsschaden (Mehraufwand)</div>
                    <div class="cost-value">${data.calculationData.healthCompensation.toFixed(2).replace('.', ',')} ‚Ç¨</div>
                </div>
            `;
        }

        summaryCalcDetails.innerHTML = html;
        console.log('‚úì Berechnungs-Details aktualisiert');
    }

    // ========== SECTION 2: Pers√∂nliche Daten ==========

    // Name mit Anrede
    const summaryName = document.getElementById('summary-name');
    if (summaryName) {
        const salutationMap = {
            'herr': 'Herr',
            'frau': 'Frau',
            'divers': ''
        };
        const salutation = salutationMap[data.personalData.salutation] || '';
        const fullName = `${salutation} ${data.personalData.firstName} ${data.personalData.lastName}`.trim();
        summaryName.textContent = fullName;
        console.log('‚úì Name aktualisiert:', fullName);
    }

    // Adresse
    const summaryAddress = document.getElementById('summary-address');
    if (summaryAddress) {
        const address = `${data.personalData.street} ${data.personalData.houseNumber}`;
        summaryAddress.textContent = address;
        console.log('‚úì Adresse aktualisiert:', address);
    }

    // Stadt
    const summaryCity = document.getElementById('summary-city');
    if (summaryCity) {
        const city = `${data.personalData.zipCode} ${data.personalData.city}`;
        summaryCity.textContent = city;
        console.log('‚úì Stadt aktualisiert:', city);
    }

    // IBAN
    const summaryIban = document.getElementById('summary-iban');
    if (summaryIban) {
        summaryIban.textContent = `IBAN: ${data.bankData.iban}`;
        console.log('‚úì IBAN aktualisiert');
    }

    // BIC
    const summaryBic = document.getElementById('summary-bic');
    if (summaryBic) {
        summaryBic.textContent = `BIC/Swift-Code: ${data.bankData.bic}`;
        console.log('‚úì BIC aktualisiert');
    }

    // Geburtsdatum
    const summaryBirthdate = document.getElementById('summary-birthdate');
    if (summaryBirthdate) {
        const birthdate = `${data.personalData.birthdate.day}.${data.personalData.birthdate.month}.${data.personalData.birthdate.year}`;
        summaryBirthdate.textContent = `Geburtsdatum: ${birthdate}`;
        console.log('‚úì Geburtsdatum aktualisiert:', birthdate);
    }

    // Email
    const summaryEmail = document.getElementById('summary-email');
    if (summaryEmail) {
        summaryEmail.textContent = data.personalData.email;
        console.log('‚úì Email aktualisiert:', data.personalData.email);
    }

    console.log('===============================================');
    console.log('‚úì Summary erfolgreich aktualisiert!');
    console.log('===============================================');
}

// Next step
window.nextStep = function() {
    console.log('===============================================');
    console.log('nextStep() aufgerufen!');
    console.log('  Current Step:', window.pkontoCurrentStep);
    console.log('===============================================');

    collectStepData();

    if (!validateCurrentStep()) {
        console.warn('WARNUNG - Validierung fehlgeschlagen - bleibe auf Step', window.pkontoCurrentStep);
        return;
    }

    if (window.pkontoCurrentStep === 1 || window.pkontoCurrentStep === 2) {
        calculateFreibetrag();
        // DIREKT UPDATE - BYPASS CACHE
        const resultAmountEl = document.getElementById('result-amount');
        if (resultAmountEl) {
            const amount = window.pkontoFormData.calculatedFreibetrag.amount;
            resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
            console.log('üí• DIREKT AKTUALISIERT (nextStep):', amount.toFixed(2), 'EUR');
        }
    }

    if (window.pkontoCurrentStep === 3) {
        updateSummary();
    }

    if (window.pkontoCurrentStep < 4) {
        goToStep(window.pkontoCurrentStep + 1);
    } else {
        console.log('INFO - Bereits auf letztem Step');
    }
};

// Previous step
window.previousStep = function() {
    console.log('===============================================');
    console.log('previousStep() aufgerufen!');
    console.log('===============================================');

    if (window.pkontoCurrentStep > 1) {
        goToStep(window.pkontoCurrentStep - 1);
    }
};

// Load Mollie Payment Methods
async function loadPaymentMethods() {
    console.log('Loading Mollie payment methods...');

    const loadingEl = document.getElementById('payment-methods-loading');
    const containerEl = document.getElementById('payment-methods-container');
    const errorEl = document.getElementById('payment-methods-error');

    try {
        // Show loading
        if (loadingEl) loadingEl.style.display = 'block';
        if (containerEl) containerEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'none';

        const backendUrl = 'https://pkonto-backend-1.onrender.com';
        const response = await fetch(`${backendUrl}/api/mollie/methods?amount=29.00`);

        if (!response.ok) {
            throw new Error('Failed to load payment methods');
        }

        const result = await response.json();
        console.log('Payment methods loaded:', result);

        if (result.success && result.data) {
            renderPaymentMethods(result.data);

            // Hide loading, show container
            if (loadingEl) loadingEl.style.display = 'none';
            if (containerEl) containerEl.style.display = 'block';
        } else {
            throw new Error('Invalid response format');
        }
    } catch (error) {
        console.error('Error loading payment methods:', error);

        // Show error
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'block';
    }
}

// Render Payment Methods UI
function renderPaymentMethods(methods) {
    const container = document.getElementById('payment-methods-container');
    if (!container) return;

    container.innerHTML = '';

    // Mollie methods is an array of method objects
    methods.forEach((method, index) => {
        const methodEl = document.createElement('div');
        methodEl.className = 'payment-option';
        methodEl.innerHTML = `
            <input type="radio" name="payment" id="${method.id}" ${index === 0 ? 'checked' : ''} value="${method.id}">
            <img src="${method.image.svg}" alt="${method.description}" class="payment-logo" style="width: 50px; height: auto;">
            <label for="${method.id}" class="payment-label">${method.description}</label>
        `;
        container.appendChild(methodEl);
    });

    console.log(`‚úì Rendered ${methods.length} payment methods`);
}

// Submit form - MOLLIE PAYMENT
window.submitForm = async function() {
    console.log('===============================================');
    console.log('submitForm() AUFGERUFEN! - MOLLIE PAYMENT');
    console.log('===============================================');

    if (!validateCurrentStep()) {
        console.warn('WARNUNG - Validierung fehlgeschlagen');
        return;
    }

    // Show loading overlay
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.classList.add('active');
    }

    collectStepData();

    const paymentRadio = document.querySelector('input[name="payment"]:checked');
    if (paymentRadio) {
        window.pkontoFormData.payment.method = paymentRadio.id;
        console.log('Zahlungsmethode:', paymentRadio.id);
    }

    const submitBtn = document.activeElement;
    if (submitBtn && submitBtn.tagName === 'BUTTON') {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Wird bearbeitet...';
    }

    try {
        console.log('Bereite Mollie Payment vor...');
        console.log('FormData:', window.pkontoFormData);

        // Call backend to create Mollie Payment
        const backendUrl = 'https://pkonto-backend-1.onrender.com';
        console.log('Backend URL:', backendUrl + '/api/mollie/create-payment');

        const response = await fetch(backendUrl + '/api/mollie/create-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(window.pkontoFormData)
        });

        console.log('Response Status:', response.status);

        if (!response.ok) {
            const errorData = await response.json();
            console.error('FEHLER - Backend Error:', errorData);
            throw new Error(errorData.message || 'Mollie Payment creation failed');
        }

        const result = await response.json();
        console.log('Mollie Payment Response:', result);

        if (result.success && result.data && result.data.checkoutUrl) {
            console.log('ERFOLGREICH!');
            console.log('Application ID:', result.data.applicationId);
            console.log('Payment ID:', result.data.paymentId);
            console.log('Redirect zu Mollie Checkout:', result.data.checkoutUrl);

            // Redirect to Mollie Checkout page
            window.location.href = result.data.checkoutUrl;
        } else {
            throw new Error('No checkout URL received');
        }

    } catch (error) {
        console.error('===============================================');
        console.error('FEHLER beim Submit!');
        console.error('===============================================');
        console.error('Error:', error);
        console.error('Message:', error.message);
        console.error('Stack:', error.stack);
        console.error('===============================================');

        // Hide loading overlay on error
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
        }

        alert('Fehler beim Erstellen der Zahlung: ' + error.message + '\n\nBitte pruefen Sie die Browser-Konsole (F12) fuer Details.');

        if (submitBtn && submitBtn.tagName === 'BUTTON') {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Jetzt kostenpflichtig beauftragen';
        }
    }
};

// Generate dynamic children input fields based on count
function generateChildrenInputs(count) {
    const container = document.getElementById('children-details-container');
    if (!container) return;

    // Clear existing content
    container.innerHTML = '';

    if (count === 0) {
        console.log('Keine Kinder ausgew√§hlt - Container leer');
        return;
    }

    console.log(`User hat ${count} Kind(er) - zeige Kindergeld-Frage...`);

    // Only show: "F√ºr wie viele Kinder erhalten Sie Kindergeld?" on Step 1
    // Details will be shown on Step 2
    const kindergeldQuestion = `
        <div class="form-question" id="kindergeld-count-question">
            <div class="question-wrapper">
                <div class="question-text">F√ºr wie viele Kinder erhalten Sie Kindergeld auf Ihr Konto?</div>
                <div class="input-group">
                    <select class="form-input" id="kindergeld-count">
                        <option value="0">0 Kinder</option>
                        <option value="1">1 Kind</option>
                        <option value="2">2 Kinder</option>
                        <option value="3">3 Kinder</option>
                        <option value="4">4 Kinder</option>
                        <option value="5">5 Kinder</option>
                        <option value="6">Mehr als 5 Kinder</option>
                    </select>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = kindergeldQuestion;

    console.log('‚úì Kindergeld-Frage angezeigt (Details kommen auf Step 2)');
}

// Generate birthdate inputs for children with Kindergeld (on Step 2)
function generateKindergeldDetails(count) {
    const detailsContainer = document.getElementById('kindergeld-details-container-step2');
    if (!detailsContainer) {
        console.warn('kindergeld-details-container-step2 not found!');
        return;
    }

    // Clear existing details
    detailsContainer.innerHTML = '';

    if (count === 0) {
        console.log('Kein Kindergeld - keine Details n√∂tig');
        return;
    }

    console.log(`Generiere Geburtsdatum-Eingaben f√ºr ${count} Kind(er) mit Kindergeld...`);

    // Helper: Get ordinal number names
    const ordinalNames = ['', 'ersten', 'zweiten', 'dritten', 'vierten', 'f√ºnften', 'sechsten'];

    // Helper: Generate all days (1-31)
    const generateDayOptions = () => {
        let options = '<option value="">Tag</option>';
        for (let d = 1; d <= 31; d++) {
            options += `<option value="${d}">${d}</option>`;
        }
        return options;
    };

    // Helper: Generate all months
    const generateMonthOptions = () => {
        const months = ['', 'Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                        'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        let options = '<option value="">Monat</option>';
        for (let m = 1; m <= 12; m++) {
            options += `<option value="${m}">${months[m]}</option>`;
        }
        return options;
    };

    // Helper: Generate years (current year back 25 years)
    const generateYearOptions = () => {
        const currentYear = new Date().getFullYear();
        let options = '<option value="">Jahr</option>';
        for (let y = currentYear; y >= currentYear - 25; y--) {
            options += `<option value="${y}">${y}</option>`;
        }
        return options;
    };

    // Generate section for each child with Kindergeld
    for (let i = 1; i <= count; i++) {
        const ordinalName = i <= 6 ? ordinalNames[i] : `${i}.`;

        const childSection = `
            <div class="children-section" id="kindergeld-child-section-${i}">
                <h4>Geburtsdatum des ${ordinalName} Kindes</h4>
                <div class="date-inputs">
                    <select class="form-input small" id="kindergeld-child-${i}-day">
                        ${generateDayOptions()}
                    </select>
                    <select class="form-input small" id="kindergeld-child-${i}-month">
                        ${generateMonthOptions()}
                    </select>
                    <select class="form-input small" id="kindergeld-child-${i}-year">
                        ${generateYearOptions()}
                    </select>
                </div>
            </div>
        `;

        detailsContainer.innerHTML += childSection;
    }

    console.log(`‚úì ${count} Kindergeld-Kind(er) Eingaben generiert`);
}

// Initialize
console.log('===============================================');
console.log('Initialisiere Form...');
console.log('===============================================');

// Initial display only - real calculation happens after AGGRESSIVE OVERRIDE
updateResultBox();

console.log('Warte auf AGGRESSIVE OVERRIDE (500ms)...');
console.log('Event Listeners werden dann registriert.');
console.log('===============================================');

// WICHTIG: Globale Aliase fuer onclick-Handler (Elementor Kompatibilitaet)
// Die Buttons im HTML verwenden onclick="nextStep()" ohne window. prefix
// Wir muessen die Funktionen auch OHNE window. prefix verfuegbar machen
console.log('Erstelle globale Funktions-Aliase...');

// Exportiere window.xxx auch als globale Variablen
if (typeof nextStep === 'undefined') {
    window.nextStep = window.nextStep;
}
if (typeof previousStep === 'undefined') {
    window.previousStep = window.previousStep;
}
if (typeof goToStep === 'undefined') {
    window.goToStep = window.goToStep;
}
if (typeof submitForm === 'undefined') {
    window.submitForm = window.submitForm;
}

// Test ob die Funktionen verfuegbar sind
console.log('Funktions-Check:');
console.log('  typeof window.nextStep:', typeof window.nextStep);
console.log('  typeof window.previousStep:', typeof window.previousStep);
console.log('  typeof window.goToStep:', typeof window.goToStep);
console.log('  typeof window.submitForm:', typeof window.submitForm);

// Test ob onclick funktioniert
console.log('Teste onclick-Zugriff:');
try {
    console.log('  eval("typeof nextStep"):', eval('typeof nextStep'));
    console.log('  eval("typeof submitForm"):', eval('typeof submitForm'));
} catch(e) {
    console.error('  FEHLER beim eval-Test:', e.message);
}

console.log('OK - Alle Funktionen registriert!');

// ============================================================================
// AGGRESSIVE OVERRIDE - L√§uft 500ms NACH DOMContentLoaded
// ============================================================================
// Dies √ºberschreibt Elementor's 481.js und andere Scripts
setTimeout(function() {
    console.log('===============================================');
    console.log('AGGRESSIVE OVERRIDE STARTET! (nach 500ms)');
    console.log('===============================================');

    // Redefine goToStep
    window.goToStep = function(step) {
        console.log('-----------------------------------------------');
        console.log('goToStep:', step, '(OVERRIDE VERSION)');
        console.log('-----------------------------------------------');

        if (step < 1 || step > 4) {
            console.error('FEHLER - Invalid step:', step);
            return;
        }

        // Update max step if moving forward
        if (step > window.pkontoMaxStep) {
            window.pkontoMaxStep = step;
        }

        // Remove active from all steps
        for (let i = 1; i <= 4; i++) {
            const stepEl = document.getElementById('step-' + i);
            if (stepEl) {
                stepEl.classList.remove('active');
                console.log('  Removed active from step-' + i);
            }

            const progressStep = document.querySelector('[data-step="' + i + '"]');
            if (progressStep) {
                progressStep.classList.remove('active');
                progressStep.classList.remove('disabled');

                if (i < step) {
                    progressStep.classList.add('completed');
                    console.log('  Step', i, 'marked as completed');
                } else {
                    progressStep.classList.remove('completed');
                }

                // Disable steps that haven't been reached yet
                if (i > window.pkontoMaxStep) {
                    progressStep.classList.add('disabled');
                }
            }
        }

        // Activate current step
        const currentStepEl = document.getElementById('step-' + step);
        if (currentStepEl) {
            currentStepEl.classList.add('active');
            console.log('OK - Step', step, 'ist jetzt aktiv!');
        } else {
            console.error('FEHLER - step-' + step + ' Element nicht gefunden!');
        }

        const currentProgressStep = document.querySelector('[data-step="' + step + '"]');
        if (currentProgressStep) {
            currentProgressStep.classList.add('active');
        }

        window.pkontoCurrentStep = step;

        // Generate Kindergeld details when navigating to Step 2 (OVERRIDE VERSION)
        if (step === 2) {
            console.log('DEBUG (OVERRIDE): Step 2 Navigation detected');
            const kindergeldCountSelect = document.getElementById('kindergeld-count');
            console.log('DEBUG (OVERRIDE): kindergeld-count element:', kindergeldCountSelect);
            const kindergeldCount = kindergeldCountSelect ? parseInt(kindergeldCountSelect.value) || 0 : 0;
            console.log(`DEBUG (OVERRIDE): Kindergeld Count = ${kindergeldCount}`);

            // Check if container exists
            const container = document.getElementById('kindergeld-details-container-step2');
            console.log('DEBUG (OVERRIDE): Container found:', container);

            console.log(`Step 2 aktiviert (OVERRIDE) - generiere Geburtsdatum-Eingaben f√ºr ${kindergeldCount} Kind(er) mit Kindergeld`);
            generateKindergeldDetails(kindergeldCount);

            // Add event listener for health compensation field on Step 2
            setTimeout(function() {
                const healthCompensationInput = document.getElementById('health-compensation');
                if (healthCompensationInput) {
                    // Remove any existing listeners
                    const newInput = healthCompensationInput.cloneNode(true);
                    healthCompensationInput.parentNode.replaceChild(newInput, healthCompensationInput);

                    newInput.addEventListener('input', function() {
                        console.log('Gesundheitsschaden-Betrag ge√§ndert:', this.value);
                        const data = window.pkontoFormData;
                        data.calculationData.healthCompensation = parseFloat(this.value) || 0;
                        calculateFreibetrag();
                        // DIREKT UPDATE - BYPASS CACHE
                        const resultAmountEl = document.getElementById('result-amount');
                        if (resultAmountEl) {
                            const amount = window.pkontoFormData.calculatedFreibetrag.amount;
                            resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
                            console.log('üí• DIREKT AKTUALISIERT:', amount.toFixed(2), 'EUR');
                        }
                    });
                    console.log('‚úì Event Listener f√ºr Gesundheitsschaden auf Step 2 hinzugef√ºgt');
                }
            }, 100);
        }

        // Update summary when navigating to Step 4 (OVERRIDE VERSION)
        if (step === 4) {
            console.log('DEBUG (OVERRIDE): Step 4 Navigation detected - updating summary');
            updateSummary();
            // Load Mollie payment methods
            loadPaymentMethods();
        }

        // Auto-Scroll zum Formular nach Step-Wechsel
        setTimeout(function() {
            const formContainer = document.querySelector('.form-container');
            if (formContainer) {
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    };

    // Redefine nextStep
    window.nextStep = function() {
        console.log('===============================================');
        console.log('nextStep() aufgerufen! (OVERRIDE VERSION)');
        console.log('  Current Step:', window.pkontoCurrentStep);
        console.log('===============================================');

        collectStepData();

        if (!validateCurrentStep()) {
            console.warn('WARNUNG - Validierung fehlgeschlagen - bleibe auf Step', window.pkontoCurrentStep);
            return;
        }

        if (window.pkontoCurrentStep === 1 || window.pkontoCurrentStep === 2) {
            calculateFreibetrag();
            // DIREKT UPDATE - BYPASS CACHE
            const resultAmountEl = document.getElementById('result-amount');
            if (resultAmountEl) {
                const amount = window.pkontoFormData.calculatedFreibetrag.amount;
                resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
                console.log('üí• DIREKT AKTUALISIERT (nextStep):', amount.toFixed(2), 'EUR');
            }
        }

        if (window.pkontoCurrentStep === 3) {
            updateSummary();
        }

        if (window.pkontoCurrentStep < 4) {
            goToStep(window.pkontoCurrentStep + 1);
        } else {
            console.log('INFO - Bereits auf letztem Step');
        }
    };

    // Redefine previousStep
    window.previousStep = function() {
        console.log('previousStep() aufgerufen! (OVERRIDE VERSION)');
        if (window.pkontoCurrentStep > 1) {
            goToStep(window.pkontoCurrentStep - 1);
        }
    };

    // Redefine submitForm with Mollie Payment
    window.submitForm = async function() {
        console.log('===============================================');
        console.log('submitForm() AUFGERUFEN! - MOLLIE PAYMENT (OVERRIDE VERSION)');
        console.log('===============================================');

        if (!validateCurrentStep()) {
            console.warn('WARNUNG - Validierung fehlgeschlagen');
            return;
        }

        // Show loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('active');
        }

        collectStepData();

        const paymentRadio = document.querySelector('input[name="payment"]:checked');
        if (paymentRadio) {
            window.pkontoFormData.payment.method = paymentRadio.id;
            console.log('Zahlungsmethode:', paymentRadio.id);
        }

        const submitBtn = document.activeElement;
        if (submitBtn && submitBtn.tagName === 'BUTTON') {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird bearbeitet...';
        }

        try {
            console.log('Bereite Mollie Payment vor...');
            console.log('FormData:', window.pkontoFormData);

            // Call backend to create Mollie Payment
            const backendUrl = 'https://pkonto-backend-1.onrender.com';
            console.log('Backend URL:', backendUrl + '/api/mollie/create-payment');

            const response = await fetch(backendUrl + '/api/mollie/create-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(window.pkontoFormData)
            });

            console.log('Response Status:', response.status);

            if (!response.ok) {
                const errorData = await response.json();
                console.error('FEHLER - Backend Error:', errorData);
                throw new Error(errorData.message || 'Mollie Payment creation failed');
            }

            const result = await response.json();
            console.log('Mollie Payment Response:', result);

            if (result.success && result.data && result.data.checkoutUrl) {
                console.log('ERFOLGREICH!');
                console.log('Application ID:', result.data.applicationId);
                console.log('Payment ID:', result.data.paymentId);
                console.log('Redirect zu Mollie Checkout:', result.data.checkoutUrl);

                // Redirect to Mollie Checkout page
                window.location.href = result.data.checkoutUrl;
            } else {
                throw new Error('No checkout URL received');
            }

        } catch (error) {
            console.error('===============================================');
            console.error('FEHLER beim Submit!');
            console.error('===============================================');
            console.error('Error:', error);
            console.error('Message:', error.message);
            console.error('Stack:', error.stack);
            console.error('===============================================');

            // Hide loading overlay on error
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }

            alert('Fehler beim Erstellen der Zahlung: ' + error.message + '\n\nBitte pruefen Sie die Browser-Konsole (F12) fuer Details.');

            if (submitBtn && submitBtn.tagName === 'BUTTON') {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Jetzt kostenpflichtig beauftragen';
            }
        }
    };

    console.log('AGGRESSIVE OVERRIDE KOMPLETT!');
    console.log('Alle Funktionen neu definiert.');
    console.log('  typeof window.goToStep:', typeof window.goToStep);
    console.log('  typeof window.nextStep:', typeof window.nextStep);
    console.log('  typeof window.previousStep:', typeof window.previousStep);
    console.log('  typeof window.submitForm:', typeof window.submitForm);
    console.log('===============================================');

    // Re-attach event listeners after override
    console.log('Event Listeners werden neu registriert...');

    // Progress Steps - Click handlers
    const progressSteps = document.querySelectorAll('.progress-steps .step');
    progressSteps.forEach(function(stepEl) {
        stepEl.addEventListener('click', function() {
            const targetStep = parseInt(stepEl.getAttribute('data-step'));
            if (targetStep && targetStep <= window.pkontoMaxStep) {
                window.goToStep(targetStep);
            }
        });
    });
    console.log('‚úì Step click handlers added (OVERRIDE)');

    // Familienstand
    const familienstandSelect = document.getElementById('familienstand');
    if (familienstandSelect) {
        console.log('DEBUG: Familienstand Element gefunden:', familienstandSelect);
        familienstandSelect.addEventListener('change', function() {
            console.log('üî• EVENT FIRED: Familienstand ge√§ndert:', this.value);
            const data = window.pkontoFormData;
            const familienstandValue = this.value;
            data.calculationData.familienstand = familienstandValue;

            // Check married status
            const unterhaltZahlung = document.getElementById('unterhalt-zahlung');
            const unterhaltValue = unterhaltZahlung ? unterhaltZahlung.value : 'nein';
            const showsUnterhaltQuestion = (familienstandValue === 'verheiratet' || familienstandValue === 'lebenspartnerschaft' || familienstandValue === 'geschieden');
            if (showsUnterhaltQuestion && unterhaltValue === 'ja') {
                data.calculationData.married = true;
            } else {
                data.calculationData.married = false;
            }

            console.log('Calling calculateFreibetrag...');
            calculateFreibetrag();
            // DIREKT UPDATE - BYPASS CACHE
            const resultAmountEl = document.getElementById('result-amount');
            if (resultAmountEl) {
                const amount = window.pkontoFormData.calculatedFreibetrag.amount;
                resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
                console.log('üí• DIREKT AKTUALISIERT:', amount.toFixed(2), 'EUR');
            }
            console.log('calculateFreibetrag finished');
        });
        console.log('‚úì Event Listener f√ºr Familienstand hinzugef√ºgt');
    } else {
        console.error('‚ùå Familienstand Element NICHT gefunden!');
    }

    // Unterhalt
    const unterhaltSelect = document.getElementById('unterhalt-zahlung');
    if (unterhaltSelect) {
        unterhaltSelect.addEventListener('change', function() {
            console.log('Unterhalt ge√§ndert:', this.value);
            const data = window.pkontoFormData;
            const familienstand = document.getElementById('familienstand');
            const familienstandValue = familienstand ? familienstand.value : 'ledig';
            const showsUnterhaltQuestion = (familienstandValue === 'verheiratet' || familienstandValue === 'lebenspartnerschaft' || familienstandValue === 'geschieden');

            if (showsUnterhaltQuestion && this.value === 'ja') {
                data.calculationData.married = true;
            } else {
                data.calculationData.married = false;
            }

            calculateFreibetrag();
            // DIREKT UPDATE - BYPASS CACHE
            const resultAmountEl = document.getElementById('result-amount');
            if (resultAmountEl) {
                const amount = window.pkontoFormData.calculatedFreibetrag.amount;
                resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
                console.log('üí• DIREKT AKTUALISIERT:', amount.toFixed(2), 'EUR');
            }
        });
        console.log('‚úì Event Listener f√ºr Unterhalt hinzugef√ºgt');
    }

    // Kinderanzahl
    const childrenCountSelect = document.getElementById('children-count');
    if (childrenCountSelect) {
        childrenCountSelect.addEventListener('change', function() {
            const count = parseInt(this.value) || 0;
            console.log('Kinderanzahl ge√§ndert auf:', count);
            const data = window.pkontoFormData;
            data.calculationData.childrenCount = count;
            generateChildrenInputs(count);
            calculateFreibetrag();
            // DIREKT UPDATE - BYPASS CACHE
            const resultAmountEl = document.getElementById('result-amount');
            if (resultAmountEl) {
                const amount = window.pkontoFormData.calculatedFreibetrag.amount;
                resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
                console.log('üí• DIREKT AKTUALISIERT:', amount.toFixed(2), 'EUR');
            }
        });
        console.log('‚úì Event Listener f√ºr Kinderanzahl hinzugef√ºgt');
    }

    // Health compensation
    const healthCompensationInput = document.getElementById('health-compensation');
    if (healthCompensationInput) {
        healthCompensationInput.addEventListener('input', function() {
            console.log('Gesundheitsschaden-Betrag ge√§ndert:', this.value);
            const data = window.pkontoFormData;
            data.calculationData.healthCompensation = parseFloat(this.value) || 0;
            calculateFreibetrag();
            // DIREKT UPDATE - BYPASS CACHE
            const resultAmountEl = document.getElementById('result-amount');
            if (resultAmountEl) {
                const amount = window.pkontoFormData.calculatedFreibetrag.amount;
                resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
                console.log('üí• DIREKT AKTUALISIERT:', amount.toFixed(2), 'EUR');
            }
        });
        console.log('‚úì Event Listener f√ºr Gesundheitsschaden-Eingabe hinzugef√ºgt');
    }

    console.log('‚úì Alle Event Listeners neu registriert (nach OVERRIDE)');

    // F√ºhre initiale Berechnung durch
    console.log('F√ºhre initiale Freibetrags-Berechnung durch...');
    calculateFreibetrag();
    // DIREKT UPDATE - BYPASS CACHE
    const resultAmountEl = document.getElementById('result-amount');
    if (resultAmountEl) {
        const amount = window.pkontoFormData.calculatedFreibetrag.amount;
        resultAmountEl.textContent = amount.toFixed(2).replace('.', ',') + ' EUR';
        console.log('üí• DIREKT AKTUALISIERT (initial):', amount.toFixed(2), 'EUR');
    }
    console.log('‚úì P-Konto Form vollst√§ndig initialisiert!');
}, 500);
</script>
